<!DOCTYPE html>
<html>
  <head>
    <title>The Mind Game</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/peerjs@1.5.0/dist/peerjs.min.js"></script>
    <style>
      * {
        word-break: break-word;
      }
    </style>
    <script type="module">
      import { html, escapeHtml } from "./utils/html.js";
      import { createGameServer } from "./utils/game-server.js";

      function render() {
        const urlSearchParams = new URLSearchParams(
          window.location.search.split("?")?.[1] || ""
        );
        const params = Object.fromEntries(urlSearchParams.entries());
        const username = localStorage.getItem("username") || "";
        const lobbyId = params.lobbyId || "";
        console.log(lobbyId, params);
        if (!username) {
          document.body.innerHTML = html`
            <div>
              <h3>The Mind</h3>
              <p>Enter your name to join the game</p>
              <form>
                <input id="name" type="text" value="${username}" />
                <button>Join</button>
              </form>
            </div>
          `;

          document.querySelector("form").addEventListener("submit", (e) => {
            e.preventDefault();
            localStorage.setItem(
              "username",
              document.querySelector("#name").value
            );
            render();
          });
        } else if (!lobbyId) {
          document.body.innerHTML = html`
            <div>
              <a href="/index.html">home</a>
              <h3>the mind. ðŸ§ </h3>
              <p>host a new game</p>
              <button id="create">create a game</button>
              <hr />
              <p>enter a lobby id to join a game</p>
              <form>
                <input id="lobbyId" type="text" value="${lobbyId}" />
                <button>join</button>
              </form>
              <hr />
              <h4>how to play</h4>
              <p>
                All players form a single team. In the first round (level 1)
                each player receives 1 card, in the second round (level 2) they
                receive 2 cards, and so on.
              </p>
              <p>
                At each level the team members must put down all their cards in
                increasing order in the center of the table on an open stack,
                one after the other. For example (4 players, level 1):
                18-34-41-73. The players do not take turns in any particular
                order.
              </p>
              <p>
                Whoever wants to put down a card, simply does so. Watch out,
                here's where it gets interesting: the players must not disclose
                anything about their own cards - no sharing of information, no
                secret signals.
              </p>
            </div>
          `;
          document.querySelector("#create").addEventListener("click", (e) => {
            console.log("click");
            const gameId = Math.floor(Math.random() * 1000000);
            window.localStorage.setItem(`isHost-${gameId}`, true);
            window.location.href = `/games/the-mind.html?lobbyId=${gameId}`;
          });
          document.querySelector("form").addEventListener("submit", (e) => {
            e.preventDefault();
            window.location.href = `/games/the-mind.html?lobbyId=${
              document.querySelector("#lobbyId").value
            }`;
          });
        } else if (lobbyId) {
          let isHost = !!window.localStorage.getItem(`isHost-${lobbyId}`);

          let server = createGameServer({
            isHost,
            roomId: `jeffy-the-mind-${lobbyId}`,
            initialState: {
              status: "waiting",
              actionLog: [],
              level: 0,
              errors: 0,
              players: {},
            },
            onAction: (state, action, send) => {
              let seen = new Set();
              function getNumber() {
                while (true) {
                  let n = Math.floor(Math.random() * (100 - 0) + 0);
                  if (!seen.has(n)) {
                    seen.add(n);
                    return n;
                  }
                }
              }

              if (action.type === "join" && !state.players[action.actor]) {
                state.players[action.actor] = {
                  playedCards: [],
                  unplayedCards: [],
                  history: [],
                };
                state.actionLog.push(`ðŸ‘‹ ${escapeHtml(action.actor)} joined`);
              }

              if (action.type === "start") {
                state.level = 1;
                state.status = "playing";
                Object.keys(state.players).forEach((player) => {
                  state.players[player] = {
                    playedCards: [],
                    unplayedCards: [getNumber()],
                    history: ["â¬œï¸"],
                  };
                });
                state.actionLog.push(`ðŸ”” ${escapeHtml(action.actor)} started the game`);
              }

              if (
                action.type === "send-number" &&
                state.players[action.actor]?.unplayedCards?.length
              ) {
                let n = state.players[action.actor].unplayedCards.shift();
                state.players[action.actor].playedCards.push(n);
                let isError = false;
                let levelIsComplete = true;
                for (let player of Object.keys(state.players)) {
                  if (state.players[player].unplayedCards.length > 0) {
                    levelIsComplete = false;
                    if (state.players[player].unplayedCards[0] < n) {
                      isError = true;
                    }
                  }
                }

                let playerState = state.players[action.actor];
                if (isError) {
                  state.errors++;
                  playerState.history[playerState.playedCards.length - 1] =
                    "âŒ";
                  state.actionLog.push(
                    `âŒ ${action.actor} sent ${n} but it was wrong!`
                  );
                } else {
                  playerState.history[playerState.playedCards.length - 1] =
                    "âœ…";
                  state.actionLog.push(`âœ… ${action.actor} sent ${n}`);
                }
                if (levelIsComplete) {
                  state.level++;
                  state.actionLog.push(`ðŸŽ‰ level ${state.level} started`);
                  Object.keys(state.players).forEach((player) => {
                    let numbers = Array.from({ length: state.level }, () =>
                      getNumber()
                    );
                    numbers = numbers.sort(function (a, b) {
                      return a - b;
                    });
                    state.players[player] = {
                      playedCards: [],
                      history: numbers.map(() => "â¬œï¸"),
                      unplayedCards: numbers,
                    };
                  });
                }
              }

              return state;
            },
            onStateChange: (state) => {
              function iff(condition = false, then = "", otherwise = "") {
                return condition ? then : otherwise;
              }
              document.body.innerHTML = html`
                <div>
                  <a href="/games/the-mind.html">back</a>
                  <h3>
                    the mind. ðŸ§ 
                    <span style="color: dodgerblue; font-size: .75em;"
                      >lobby ${lobbyId}</span
                    >
                  </h3>

                  ${iff(
                    state.status === "playing",
                    `<p>level ${state.level}, ${state.errors} errors</p>`
                  )}
                  <h4>players</h4>
                  <ul>
                    ${Object.keys(state.players)
                      .map(
                        (player) =>
                          html`<li>
                            ${escapeHtml(player)}${iff(
                              player === username,
                              " (you)",
                              iff()
                            )}
                            ${iff(
                              isHost && player === username,
                              ' <span style="background-color: lightgreen">host</span>'
                            )}
                            ${iff(
                              state.status === "playing",
                              `[${state.players[player]?.history?.join?.("")}]`
                            )}
                          </li>`
                      )
                      .join("")}
                  </ul>

                  ${iff(
                    state.status === "playing",
                    html`<h4>your cards</h4>
                      <div>
                        <div style="display: flex; flex-wrap: wrap">
                          ${state.players[username]?.playedCards
                            ?.map(
                              (card, i) =>
                                html`<div
                                  style="padding: 5px; margin: 5px; border: 1px solid black; border-radius: 5px; min-height: 100px; min-width: 50px;"
                                >
                                  <p style="text-align: center">${card}</p>
                                  <p style="text-align: center">
                                    ${state.players[username]?.history?.[i]}
                                  </p>
                                </div>`
                            )
                            .join("")}
                          ${state.players[username]?.unplayedCards
                            ?.map(
                              (card, idx) =>
                                html`<div
                                  style="padding: 5px; margin: 5px; border: 1px solid black; border-radius: 5px; min-height: 100px; min-width: 50px;"
                                >
                                  <p style="text-align: center">${card}</p>
                                  ${idx === 0
                                    ? '<button style="display: block; margin: 0 8px;" id="send-number">play</button>'
                                    : ""}
                                </div>`
                            )
                            .join("")}
                        </div>
                      </div> `
                  )}
                  ${iff(
                    isHost && state.status === "waiting",
                    html`<button id="start">Start</button>`
                  )}
                  ${iff(
                    !isHost && state.status === "waiting",
                    html`<p>waiting for host to start...</p>`
                  )}
                  <ul>
                    ${[...state.actionLog]
                      .reverse()
                      .map((action) => html`<li>${action}</li>`)
                      .join("")}
                  </ul>
                  <p>
                    Others can join using the code ${escapeHtml(lobbyId)} or by visiting this link:
                    <a href="${window.location.href}"
                      >${window.location.href}</a
                    >
                  </p>
                  <br />
                  <br />
                  <br />
                  <h4>how to play</h4>
                  <p>
                    All players form a single team. In the first round (level 1)
                    each player receives 1 card, in the second round (level 2)
                    they receive 2 cards, and so on.
                  </p>
                  <p>
                    At each level the team members must put down all their cards
                    in increasing order in the center of the table on an open
                    stack, one after the other. For example (4 players, level
                    1): 18-34-41-73. The players do not take turns in any
                    particular order.
                  </p>
                  <p>
                    Whoever wants to put down a card, simply does so. Watch out,
                    here's where it gets interesting: the players must not
                    disclose anything about their own cards - no sharing of
                    information, no secret signals.
                  </p>
                </div>
              `;

              document
                .querySelector("#start")
                ?.addEventListener("click", (e) => {
                  e.preventDefault();
                  server.send({ type: "start", actor: username });
                });

              document
                .querySelector("#send-number")
                ?.addEventListener?.("click", (e) => {
                  server.send({ type: "send-number", actor: username });
                });
            },
          });
          server.send({ type: "join", actor: username });
        }
      }

      render();
    </script>
  </head>
  <body>
    <p>loading...</p>
    <!-- Your content here -->
  </body>
</html>
